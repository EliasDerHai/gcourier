#!/bin/sh

BIN_NAME="proxy"
OSES="darwin linux windows"
ARCHES="x86_64 aarch64"
get_goarch() {
  case "$1" in
    x86_64) echo "amd64" ;;
    aarch64) echo "arm64" ;;
    *) echo "unknown" ;;
  esac
}

ROOT_DIR="./priv"

for OS in $OSES; do
  for ARCH in $ARCHES; do
    GOOS="$OS"
    GOARCH="$(get_goarch "$ARCH")"
    if [ "$GOARCH" = "unknown" ]; then
      echo "Skipping unknown architecture: $ARCH"
      continue
    fi

    EXT=""
    [ "$GOOS" = "windows" ] && EXT=".exe"

    OUTDIR="$ROOT_DIR/$OS/$ARCH"
    OUTFILE="$OUTDIR/$BIN_NAME$EXT"

    echo "Building for $GOOS/$GOARCH -> $OUTFILE"
    mkdir -p "$OUTDIR"
    GOOS="$GOOS" GOARCH="$GOARCH" go build -o "$OUTFILE" proxy/main.go
  done
done
